# Story 1.3: Bling OAuth 2.0 ‚Äî Conex√£o da Conta 2

---

## ‚ö° Parallel Execution Map

```
WAVE 1 ‚úÖ 1.1 Project Scaffold (pr√©-requisito)

WAVE 2 ‚Äî VOC√ä EST√Å AQUI ‚Äî pode rodar em paralelo:
  ‚îú‚îÄ‚îÄ ‚Üí 1.2 Bling OAuth ‚Äî Conta 1        ‚Üê PARALLEL com esta story
  ‚îú‚îÄ‚îÄ ‚Üí 1.3 Bling OAuth ‚Äî Conta 2        ‚Üê YOU ARE HERE
  ‚îî‚îÄ‚îÄ ‚Üí 2.1 Seletor de Per√≠odo Mensal    ‚Üê PARALLEL com esta story
```

> **1.3 pode ser desenvolvida em paralelo com 1.2** ‚Äî s√£o fluxos OAuth completamente independentes com credenciais e tokens separados. O token manager da Story 1.2 (`/lib/bling/token-manager.ts`) deve ser reutilizado com `account_number=2`.

---

## Status

Ready

---

## Executor Assignment

```
executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "integration-test"]
```

---

## Story

**As a** user,
**I want** to connect a second Bling account independently,
**so that** I can consolidate data from both companies.

---

## Acceptance Criteria

1. Fluxo OAuth independente para Conta 2, usando `BLING_CLIENT_ID_2` / `BLING_CLIENT_SECRET_2`, separado da Conta 1
2. Ambas as contas exibem status de conex√£o na tela de configura√ß√µes (Conta 1 e Conta 2 lado a lado)
3. Sistema suporta opera√ß√£o com apenas 1 conta conectada ‚Äî Conta 2 √© opcional; fluxo de an√°lise prossegue sem ela
4. Tokens da Conta 2 armazenados separadamente no Supabase (mesmo schema, `account_number=2`)
5. Bot√£o de desconectar dispon√≠vel para cada conta individualmente ‚Äî limpa tokens do Supabase sem afetar a outra conta

---

## Scope

### IN scope
- Extens√£o do fluxo OAuth para suportar `account=2` com credenciais `BLING_CLIENT_ID_2` / `BLING_CLIENT_SECRET_2`
- Tela de configura√ß√µes com dois cards de status lado a lado (Conta 1 e Conta 2)
- Bot√£o de desconectar por conta (sem afetar a outra)
- L√≥gica de "Conta 2 √© opcional" ‚Äî an√°lise prossegue com apenas Conta 1

### OUT of scope
- Cria√ß√£o da tabela `bling_tokens` (Story 1.2 ‚Äî pr√©-requisito obrigat√≥rio)
- Cria√ß√£o do `token-manager.ts` (Story 1.2 ‚Äî pr√©-requisito obrigat√≥rio)
- Estado da sess√£o de an√°lise durante desconex√£o (n√£o tratado nesta vers√£o)
- Suporte a mais de 2 contas

### Depend√™ncias obrigat√≥rias (hard blockers)
> ‚õî **Story 1.2 DEVE estar conclu√≠da antes do in√≠cio desta story.**
> Tabela `bling_tokens`, `/lib/bling/token-manager.ts` e a API Route de callback devem existir e estar funcionando.

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Story 1.2 desenvolvida em paralelo e n√£o mergeada ‚Äî impede reutiliza√ß√£o de `token-manager.ts` e schema `bling_tokens` | Medium | High | Coordenar merge de 1.2 antes de iniciar 1.3. Usar hard blocker como depend√™ncia. |
| Desconectar Conta 2 durante an√°lise em andamento pode corromper dados de sess√£o | Low | Medium | Fora de escopo nesta vers√£o ‚Äî documentar como tech debt. |
| Mesmo `BLING_REDIRECT_URI` para ambas as contas ‚Äî diferencia√ß√£o de conta deve ser feita via par√¢metro `state` | Medium | Medium | Validar que `state` inclui `account_number` e verificar no callback. |

---

## ü§ñ CodeRabbit Integration

### Story Type Analysis

**Primary Type**: Security / Authentication
**Secondary Type(s)**: API Integration
**Complexity**: Low-Medium (reutiliza padr√µes da Story 1.2)

### Specialized Agent Assignment

**Primary Agents**:
- @dev: Extens√£o do OAuth para Conta 2, l√≥gica de "conta opcional"

**Supporting Agents**:
- @qa: Teste de desconex√£o sem afetar Conta 1

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Verificar que tokens Conta 1 e Conta 2 s√£o completamente isolados
- [ ] Pre-PR (@devops): Verificar vari√°veis de ambiente Conta 2 na Vercel

### Self-Healing Configuration

**Expected Self-Healing**:
- Primary Agent: @dev (light mode)
- Max Iterations: 2
- Timeout: 15 minutes
- Severity Filter: CRITICAL, HIGH

**Predicted Behavior**:
- CRITICAL issues: auto_fix
- HIGH issues: document_as_tech_debt

### CodeRabbit Focus Areas

**Primary Focus**:
- Security: Tokens Conta 2 isolados, sem mistura com Conta 1
- Logic: `account_number` parameter sempre validado como `1` ou `2`

**Secondary Focus**:
- UX: Feedback claro de qual conta est√° sendo conectada/desconectada
- Error handling: Desconectar Conta 2 n√£o afeta estado da Conta 1

---

## Tasks / Subtasks

- [ ] Estender API Route de in√≠cio do OAuth para Conta 2 (AC: 1)
  - [ ] `GET /api/auth/bling/connect?account=2` ‚Üí usa `BLING_CLIENT_ID_2` / `BLING_CLIENT_SECRET_2`
  - [ ] Reutilizar l√≥gica da Story 1.2, parametrizado por `account`
  - [ ] Validar que `account` √© `1` ou `2` (throw 400 para outros valores)
- [ ] Estender callback para Conta 2 (AC: 1, 4)
  - [ ] Callback j√° gen√©rico por `account` ‚Äî verificar que salva com `account_number=2`
  - [ ] Reutilizar `token-manager.ts` da Story 1.2
- [ ] Atualizar tela de configura√ß√µes com status de ambas as contas (AC: 2)
  - [ ] Layout: dois cards lado a lado ‚Äî "Conta Bling 1" e "Conta Bling 2"
  - [ ] Cada card: status (Conectado/N√£o conectado), bot√£o conectar/desconectar
- [ ] Implementar l√≥gica de "Conta 2 opcional" (AC: 3)
  - [ ] Fun√ß√£o utilit√°ria `getConnectedAccounts(): number[]` retorna `[1]` ou `[1, 2]`
  - [ ] Todas as chamadas √† Bling API iteram sobre contas conectadas apenas
  - [ ] Fluxo de an√°lise n√£o bloqueia se apenas Conta 1 conectada
- [ ] Implementar desconex√£o por conta (AC: 5)
  - [ ] `DELETE /api/auth/bling/disconnect?account=1` ou `?account=2`
  - [ ] Remove registro da tabela `bling_tokens` onde `account_number = ?`
  - [ ] N√£o afeta tokens da outra conta
  - [ ] Confirmar a√ß√£o no frontend antes de executar

---

## Dev Notes

### Reutiliza√ß√£o da Story 1.2 (IDS: ADAPT)
Esta story √© uma **adapta√ß√£o** da Story 1.2. O c√≥digo deve ser parametrizado por `account_number` (1 ou 2), n√£o duplicado. Se a Story 1.2 ainda n√£o foi conclu√≠da, coordinate com o outro dev ou aguarde.

### Depend√™ncia T√©cnica
- Tabela `bling_tokens` j√° criada pela Story 1.2 com `UNIQUE(account_number)` ‚Äî reutilizar
- `/lib/bling/token-manager.ts` j√° criado pela Story 1.2 ‚Äî reutilizar com `accountNumber: 1 | 2`

### L√≥gica de Conta Opcional
```typescript
// /lib/bling/accounts.ts
export async function getConnectedAccounts(): Promise<(1 | 2)[]> {
  const { data } = await supabaseServer
    .from('bling_tokens')
    .select('account_number');
  return data?.map(r => r.account_number) ?? [];
}
```

### Vari√°veis de Ambiente para Conta 2
- `BLING_CLIENT_ID_2`
- `BLING_CLIENT_SECRET_2`
- Mesmo `BLING_REDIRECT_URI` (callback diferencia por `state` ou param)

### Testing
- Testar desconex√£o Conta 2 ‚Üí Conta 1 permanece intacta
- Testar fluxo de an√°lise com apenas Conta 1 conectada ‚Üí sem erros
- Arquivo: `__tests__/api/auth/bling/disconnect.test.ts`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-20 | 1.0.0 | Story criada pelo @sm a partir do PRD | River (@sm) |
| 2026-02-21 | 1.1.0 | Adicionadas se√ß√µes Scope e Risks; depend√™ncia hard blocker em 1.2 formalizada per valida√ß√£o @po | River (@sm) |
| 2026-02-23 | 1.2.0 | @po validation ‚Äî Score 9/10 ‚Äî GO ‚Äî Status Draft ‚Üí Ready | Pax (@po) |

---

## Dev Agent Record

### Agent Model Used
_A ser preenchido pelo @dev_

### Debug Log References
_A ser preenchido pelo @dev_

### Completion Notes List
_A ser preenchido pelo @dev_

### File List
_A ser preenchido pelo @dev_

---

## QA Results
_A ser preenchido pelo @qa_
