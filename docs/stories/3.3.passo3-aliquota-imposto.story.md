# Story 3.3: Passo 3 â€” ConfiguraÃ§Ã£o de AlÃ­quota de Imposto

---

## âš¡ Parallel Execution Map

```
WAVE 1 âœ… 1.1 Project Scaffold
WAVE 2 âœ… 2.1 Seletor de PerÃ­odo (prÃ©-requisito desta story)

WAVE 4 â€” VOCÃŠ ESTÃ AQUI â€” pode rodar em paralelo com 3.1 e 3.2:
  â”œâ”€â”€ â†’ 3.1 Passo 1 â€” CMV por Produto    â† PARALLEL (depende de 2.2)
  â”œâ”€â”€ â†’ 3.2 Passo 2 â€” CategorizaÃ§Ã£o      â† PARALLEL (depende de 2.3)
  â””â”€â”€ â†’ 3.3 Passo 3 â€” AlÃ­quota           â† YOU ARE HERE
```

> **3.3 tem a menor dependÃªncia de todas as stories da Wave 4** â€” requer apenas que 2.1 (seletor de perÃ­odo) esteja pronta. Ã‰ a tela mais simples do fluxo e pode ser desenvolvida completamente em paralelo com 3.1 e 3.2.

---

## Status

Ready for Review

---

## Executor Assignment

```
executor: "@dev"
quality_gate: "@dev"
quality_gate_tools: ["lint", "typecheck", "unit-test"]
```

---

## Story

**As a** user,
**I want** to input the tax rate (%) to be considered for the month,
**so that** the system deducts the correct tax amount from the selling price.

---

## Acceptance Criteria

1. Input numÃ©rico para alÃ­quota (%) com o valor do mÃªs anterior prÃ©-preenchido automaticamente (se disponÃ­vel no Supabase)
2. ValidaÃ§Ã£o: valor deve ser entre 0% e 100% (inclusive); exibir mensagem de erro para valores invÃ¡lidos
3. Preview em tempo real mostrando o impacto da alÃ­quota no preÃ§o: exemplo com o primeiro produto da lista do mÃªs
4. AlÃ­quota persistida por mÃªs/ano no Supabase (cada mÃªs tem sua prÃ³pria alÃ­quota)
5. BotÃ£o "Calcular Resultado" dispara o cÃ¡lculo da Margem de ContribuiÃ§Ã£o e navega para o relatÃ³rio final

---

## Scope

### IN scope
- Input numÃ©rico de alÃ­quota com validaÃ§Ã£o 0â€“100%
- PrÃ©-preenchimento com alÃ­quota do mÃªs anterior (do Supabase)
- Preview em tempo real do impacto da alÃ­quota (exemplo com primeiro produto)
- PersistÃªncia da alÃ­quota por `(month, year)` na tabela `monthly_config`
- BotÃ£o "Calcular Resultado" que salva e navega para `/resultado`

### OUT of scope
- AlÃ­quotas diferentes por tipo de produto
- Detalhamento de impostos por tipo (ICMS, ISS, PIS, COFINS etc.)
- ConfiguraÃ§Ã£o de regime tributÃ¡rio
- CÃ¡lculo de imposto acumulado anual
- SimulaÃ§Ã£o de cenÃ¡rios com mÃºltiplas alÃ­quotas

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| TransiÃ§Ã£o de ano (Dezembro â†’ Janeiro): busca por "mÃªs anterior" precisa lidar com rollover de ano (mÃªs 1 do ano atual â†’ mÃªs 12 do ano anterior) | Medium | Low | Implementar lÃ³gica: `if (month === 1) { prevMonth = 12; prevYear = year - 1 }` |
| AlÃ­quota decimal (ex: 6.5%) pode ter erros de floating point na multiplicaÃ§Ã£o | Low | Medium | Usar `Math.round(value * 100) / 100` ou validar com dois casas decimais no input. |

---

## ðŸ¤– CodeRabbit Integration

### Story Type Analysis

**Primary Type**: Frontend / UI
**Secondary Type(s)**: Database
**Complexity**: Low

### Specialized Agent Assignment

**Primary Agents**:
- @dev: Input de alÃ­quota, preview em tempo real, persistÃªncia

**Supporting Agents**:
- @ux-design-expert: Preview em tempo real de forma clara e educativa

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Unit tests de validaÃ§Ã£o e cÃ¡lculo do preview, lint, typecheck

### Self-Healing Configuration

**Expected Self-Healing**:
- Primary Agent: @dev (light mode)
- Max Iterations: 2
- Timeout: 15 minutes
- Severity Filter: CRITICAL, HIGH

**Predicted Behavior**:
- CRITICAL issues: auto_fix
- HIGH issues: document_as_tech_debt

### CodeRabbit Focus Areas

**Primary Focus**:
- Validation: 0% â‰¤ alÃ­quota â‰¤ 100%, tratamento de decimais
- UX: Preview em tempo real sem debounce excessivo (mÃ¡x 300ms)

**Secondary Focus**:
- Accessibility: Label claro no input, erro acessÃ­vel
- Type safety: `aliquota` como `number` entre 0 e 100 (nÃ£o string)

---

## Tasks / Subtasks

- [x] Criar tela Passo 3 â€” AlÃ­quota (AC: 1)
  - [x] PÃ¡gina `/passo-3` com input numÃ©rico de alÃ­quota
  - [x] Label: "AlÃ­quota de Imposto (%)" com hint: "Ex: 6 para Simples Nacional 6%"
  - [x] Aceitar decimais (ex: 6.5%)
- [x] Carregar alÃ­quota do mÃªs anterior do Supabase (AC: 1)
  - [x] `GET /api/aliquota?month=M&year=Y` â†’ busca alÃ­quota do mÃªs anterior como sugestÃ£o
  - [x] Se nÃ£o houver registro anterior, campo inicia vazio
- [x] Implementar validaÃ§Ã£o (AC: 2)
  - [x] ValidaÃ§Ã£o em tempo real: valor deve ser >= 0 e <= 100
  - [x] Mensagem de erro inline: "A alÃ­quota deve ser entre 0% e 100%"
  - [x] BotÃ£o "Calcular Resultado" desabilitado se invÃ¡lido
- [x] Implementar preview em tempo real (AC: 3)
  - [x] Abaixo do input: "Preview: Produto X â€” PreÃ§o R$ 100,00 â†’ Imposto R$ 6,00 â†’ PreÃ§o lÃ­quido R$ 94,00"
  - [x] Atualizar ao digitar (debounce 300ms)
  - [x] Usar o primeiro produto da lista da Story 2.2 como exemplo
- [x] Criar tabela `monthly_config` no Supabase e API (AC: 4)
  - [x] Schema: `month INTEGER, year INTEGER, aliquota DECIMAL(5,2), PRIMARY KEY(month, year)`
  - [x] `POST /api/aliquota` â†’ upsert da alÃ­quota para o mÃªs/ano atual
- [x] Implementar "Calcular Resultado" (AC: 5)
  - [x] Salvar alÃ­quota no Supabase
  - [x] Chamar `POST /api/calculate` (Story 4.1) ou navegar para `/resultado` com dados em Context
  - [x] Loading state no botÃ£o

---

## Dev Notes

### Schema Supabase â€” Tabela `monthly_config`
```sql
CREATE TABLE monthly_config (
  month INTEGER NOT NULL CHECK (month BETWEEN 1 AND 12),
  year INTEGER NOT NULL,
  aliquota DECIMAL(5, 2) NOT NULL DEFAULT 0 CHECK (aliquota BETWEEN 0 AND 100),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  PRIMARY KEY (month, year)
);
```

### FÃ³rmula de Preview (PRD FR8)
```
Imposto = PreÃ§oVenda Ã— (AlÃ­quota / 100)
PreÃ§oLÃ­quido = PreÃ§oVenda âˆ’ Imposto

Exemplo: PreÃ§o R$ 100,00 Ã— 6% = R$ 6,00 imposto â†’ R$ 94,00 lÃ­quido
```

### IntegraÃ§Ã£o com Story 4.1
- A alÃ­quota salva aqui Ã© o input principal do motor de cÃ¡lculo
- A Story 4.1 lÃª `aliquota` da tabela `monthly_config` para o mÃªs/ano selecionado

### Fluxo apÃ³s "Calcular Resultado"
```
Salvar alÃ­quota â†’ POST /api/calculate â†’ navegar para /resultado (Story 4.2)
```

### Testing
- Unit test: validaÃ§Ã£o de alÃ­quota (0, 100, 50.5, -1, 101, "abc")
- Unit test: cÃ¡lculo do preview com produto exemplo
- Arquivo: `__tests__/components/AliquotaInput.test.tsx`
- Arquivo: `__tests__/api/aliquota.test.ts`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-20 | 1.0.0 | Story criada pelo @sm a partir do PRD | River (@sm) |
| 2026-02-21 | 1.1.0 | Adicionadas seÃ§Ãµes Scope e Risks per validaÃ§Ã£o @po | River (@sm) |
| 2026-02-23 | 1.2.0 | @po validation â€” Score 10/10 â€” GO â€” Status Draft â†’ Ready | Pax (@po) |
| 2026-02-23 | 1.3.0 | @dev continued â€” fixed 3 failing test assertions (jest-dom v6 \xa0 normalization bug), all 129 tests pass, lint+typecheck clean, status â†’ Ready for Review | Dex (@dev) |

---

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-6

### Debug Log References
- Fix: `__tests__/components/AliquotaInput.test.tsx` â€” `\xa0` replaced with regular space in currency assertions. Root cause: jest-dom v6 `toHaveTextContent` normalizes `node.textContent` (converts `\xa0` â†’ ` `) but passes `checkWith` as-is to `String.includes()`, so `\xa0` in expected strings never matched the normalized textContent.

### Completion Notes List
- All AC implemented: input validation, prev-month prefill, real-time preview (300ms debounce), Supabase upsert, "Calcular Resultado" button with loading state and navigation to `/resultado`
- Migration `20260223000003_create_monthly_config.sql` already in place
- Year-rollover logic handled (`month === 1` â†’ `prevMonth=12, prevYear=year-1`)
- Floating-point precision handled with `Math.round(x * 100) / 100`

### File List
- `app/passo-3/page.tsx` â€” Page component (modified/confirmed)
- `app/api/aliquota/route.ts` â€” GET + POST API route (modified/confirmed)
- `components/aliquota/AliquotaInput.tsx` â€” Input + preview component (modified/confirmed)
- `supabase/migrations/20260223000003_create_monthly_config.sql` â€” DB migration (confirmed)
- `__tests__/components/AliquotaInput.test.tsx` â€” Component tests (fixed: \xa0 â†’ regular space)
- `__tests__/api/aliquota.test.ts` â€” API route tests (confirmed)

---

## QA Results
_A ser preenchido pelo @qa_
