# Story 3.1: Passo 1 â€” Preenchimento de CMV por Produto

---

## âš¡ Parallel Execution Map

```
WAVE 1 âœ… 1.1 Project Scaffold
WAVE 2 âœ… 1.2 + 1.3 OAuth | âœ… 2.1 Seletor de PerÃ­odo
WAVE 3 âœ… 2.2 Busca de Notas Fiscais (prÃ©-requisito desta story)

WAVE 4 â€” VOCÃŠ ESTÃ AQUI â€” pode rodar em paralelo com 3.2 e 3.3:
  â”œâ”€â”€ â†’ 3.1 Passo 1 â€” CMV por Produto    â† YOU ARE HERE (depende de 2.2)
  â”œâ”€â”€ â†’ 3.2 Passo 2 â€” CategorizaÃ§Ã£o      â† PARALLEL (depende de 2.3)
  â””â”€â”€ â†’ 3.3 Passo 3 â€” AlÃ­quota           â† PARALLEL (depende de 2.1)
```

> **3.1, 3.2 e 3.3 podem ser desenvolvidas em paralelo** â€” cada uma Ã© um passo independente do fluxo wizard, com suas prÃ³prias dependÃªncias de dados e telas separadas.

---

## Status

Ready for Review

---

## Executor Assignment

```
executor: "@dev"
quality_gate: "@dev"
quality_gate_tools: ["lint", "typecheck", "unit-test"]
```

---

## Story

**As a** user,
**I want** to fill in the unit cost (CMV) for each product sold in the month,
**so that** the system can calculate the accurate contribution margin.

---

## Acceptance Criteria

1. Tabela exibe todos os produtos consolidados do mÃªs com colunas: Nome do Produto, Quantidade Vendida, PreÃ§o MÃ©dio de Venda
2. Coluna "CMV UnitÃ¡rio (R$)" editÃ¡vel inline para cada produto diretamente na tabela (sem modais)
3. CMV preenchido anteriormente para o mesmo produto (qualquer mÃªs) Ã© carregado automaticamente do Supabase
4. ValidaÃ§Ã£o: CMV deve ser um nÃºmero positivo; exibir erro inline se CMV >= preÃ§o de venda
5. BotÃ£o "Salvar e Continuar" persiste todos os CMVs no Supabase e navega para o Passo 2
6. Indicador visual de campos pendentes: linha com CMV vazio destacada (borda amarela/Ã¢mbar)

---

## Scope

### IN scope
- Tabela editÃ¡vel com produtos consolidados da Story 2.2
- EdiÃ§Ã£o inline de CMV por produto (sem modais)
- Carregamento automÃ¡tico de CMVs anteriores do Supabase (tabela `product_cmv`)
- ValidaÃ§Ã£o: CMV > 0 e CMV < preÃ§o de venda
- Indicador visual de linhas pendentes (sem CMV)
- Salvar e navegar para Passo 2

### OUT of scope
- **CMV por produto por mÃªs (simplificaÃ§Ã£o de MVP):** Esta versÃ£o armazena um Ãºnico CMV por produto (o mais recente vence). O PRD FR5 especifica CMV mensal â€” esta Ã© uma simplificaÃ§Ã£o consciente. Tech debt registrado para versÃ£o pÃ³s-MVP.
- ImportaÃ§Ã£o em lote de CMVs (CSV/Excel)
- HistÃ³rico de alteraÃ§Ãµes de CMV por produto
- GestÃ£o de catÃ¡logo de produtos
- CMV para produtos nÃ£o vendidos no perÃ­odo

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| **Desvio do PRD FR5:** CMV armazenado sem referÃªncia de mÃªs pode causar imprecisÃ£o se custos variarem mÃªs a mÃªs | Medium | Medium | Aceito como simplificaÃ§Ã£o de MVP. Registrar em backlog: "Evoluir `product_cmv` para chave composta `(product_name, month, year)`". |
| Dados de NF (lista de produtos) devem estar disponÃ­veis no Context da Story 2.2 â€” se ausentes, tela nÃ£o pode renderizar | High | High | Verificar presenÃ§a de dados no Context ao montar o componente; redirecionar para Dashboard se ausentes. |
| Supabase indisponÃ­vel ao carregar CMVs anteriores â€” impede prÃ©-preenchimento | Low | Low | Tratar erro graciosamente: campo inicia vazio, usuÃ¡rio preenche manualmente. |

---

## ðŸ¤– CodeRabbit Integration

### Story Type Analysis

**Primary Type**: Frontend / UI
**Secondary Type(s)**: Database, API
**Complexity**: Medium

### Specialized Agent Assignment

**Primary Agents**:
- @dev: Tabela editÃ¡vel inline, persistÃªncia Supabase, validaÃ§Ã£o

**Supporting Agents**:
- @ux-design-expert: EdiÃ§Ã£o inline sem modais, feedback visual de pendÃªncias

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Unit tests de validaÃ§Ã£o de CMV, lint, typecheck
- [ ] Pre-PR (@devops): Testar persistÃªncia no Supabase real

### Self-Healing Configuration

**Expected Self-Healing**:
- Primary Agent: @dev (light mode)
- Max Iterations: 2
- Timeout: 15 minutes
- Severity Filter: CRITICAL, HIGH

**Predicted Behavior**:
- CRITICAL issues: auto_fix
- HIGH issues: document_as_tech_debt

### CodeRabbit Focus Areas

**Primary Focus**:
- UX: EdiÃ§Ã£o inline fluida, sem recarregar a pÃ¡gina ao salvar CMV individual
- Validation: CMV positivo e < preÃ§o de venda â€” erro claro e imediato

**Secondary Focus**:
- Accessibility: Tabela com headers semÃ¢nticos, campos editÃ¡veis acessÃ­veis
- Data persistence: NFR6 â€” CMVs persistidos no banco, nÃ£o apenas em memÃ³ria

---

## Tasks / Subtasks

- [x] Criar tabela de produtos (AC: 1)
  - [x] Componente `<ProductCMVTable products={ProductSale[]} />`
  - [x] Colunas: Nome do Produto | Qtd Vendida | PreÃ§o MÃ©dio (R$) | CMV UnitÃ¡rio (R$)
  - [x] Dados vindos do resultado da Story 2.2 (via Context ou prop drilling)
- [x] Implementar ediÃ§Ã£o inline de CMV (AC: 2)
  - [x] Campo `<input type="number" />` na coluna CMV para cada linha
  - [x] Atualiza estado local ao digitar (sem salvar no banco ainda)
  - [x] Estilo: minimalista, alinhado Ã  direita, formato moeda
- [x] Carregar CMVs anteriores do Supabase (AC: 3)
  - [x] Criar tabela `product_cmv` no Supabase
  - [x] Schema: `product_name TEXT, cmv_unitario DECIMAL, updated_at TIMESTAMPTZ`
  - [x] `GET /api/cmv?products[]=nome1&products[]=nome2` â†’ retorna CMVs salvos
  - [x] PrÃ©-preencher campos ao carregar a pÃ¡gina
- [x] Implementar validaÃ§Ã£o de CMV (AC: 4)
  - [x] ValidaÃ§Ã£o em tempo real: valor deve ser > 0
  - [x] ValidaÃ§Ã£o ao salvar: CMV nÃ£o pode ser >= `valorUnitario` do produto
  - [x] Mensagem de erro inline abaixo do campo (nÃ£o bloquear, apenas avisar)
- [x] Implementar indicador visual de pendÃªncias (AC: 6)
  - [x] Linha com CMV vazio ou zero: destacar com borda/fundo Ã¢mbar
  - [x] Contador "X produto(s) sem CMV" acima da tabela
- [x] Implementar "Salvar e Continuar" (AC: 5)
  - [x] `POST /api/cmv` â†’ upsert de todos os CMVs preenchidos no Supabase
  - [x] Validar todos os campos antes de salvar
  - [x] Loading state no botÃ£o durante o save
  - [x] ApÃ³s salvar com sucesso: navegar para `/passo-2`

---

## Dev Notes

### Schema Supabase â€” Tabela `product_cmv`
```sql
CREATE TABLE product_cmv (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  product_name TEXT NOT NULL,
  cmv_unitario DECIMAL(10, 2) NOT NULL DEFAULT 0,
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(product_name)  -- um CMV por produto (mais recente vence)
);
```

> **Nota**: O PRD (FR5) pede CMV por produto por mÃªs. SimplificaÃ§Ã£o inicial: um CMV por produto (o mais recente). Se necessÃ¡rio evoluir para `(product_name, month, year)` no futuro.

### Fluxo de Dados
```
Story 2.2 busca NFs â†’ lista de ProductSale[]
  â†“
Story 3.1 carrega CMVs anteriores do Supabase
  â†“
UsuÃ¡rio edita CMVs inline
  â†“
"Salvar e Continuar" â†’ POST /api/cmv â†’ Supabase â†’ navega para Passo 2
```

### IntegraÃ§Ã£o com Story 4.1
- Os CMVs salvos aqui serÃ£o lidos pelo motor de cÃ¡lculo da Story 4.1
- A funÃ§Ã£o `calculateContributionMargin` espera `ProductSale[]` com `cmvUnitario` preenchido

### PersistÃªncia entre Meses (FR5)
- CMV salvo sem referÃªncia de mÃªs â€” reutilizado em meses subsequentes
- Campo de CMV prÃ©-preenchido automaticamente no prÃ³ximo mÃªs

### Testing
- Unit test: validaÃ§Ã£o de CMV (positivo, menor que preÃ§o)
- Unit test: prÃ©-preenchimento de CMVs do Supabase
- Arquivo: `__tests__/components/ProductCMVTable.test.tsx`
- Arquivo: `__tests__/api/cmv.test.ts`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-20 | 1.0.0 | Story criada pelo @sm a partir do PRD | River (@sm) |
| 2026-02-21 | 1.1.0 | Adicionadas seÃ§Ãµes Scope e Risks; desvio do PRD FR5 documentado no Scope OUT per validaÃ§Ã£o @po | River (@sm) |
| 2026-02-23 | 1.2.0 | @po validation â€” Score 10/10 â€” GO â€” Status Draft â†’ Ready | Pax (@po) |
| 2026-02-23 | 1.3.0 | @dev implementation complete â€” all 6 tasks done, 30 tests, lint/typecheck clean â€” Status â†’ Ready for Review | Dex (@dev) |

---

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-6

### Debug Log References
None required â€” implementation was straightforward.

### Completion Notes List
- Migration uses `UNIQUE(product_name)` â€” upsert on conflict replaces previous CMV (MVP simplification per Scope OUT)
- `/passo-1` page fetches products directly from `/api/bling/notas-fiscais` using the PeriodContext (prop drilling approach from story)
- GET `/api/cmv` returns empty `{}` gracefully when Supabase is unavailable (risk mitigation per Risks table)
- Validation: real-time on `onChange` (>0), full scan on save (>=valorUnitario blocks save)
- Pending rows use `border-l-2 border-l-amber-400 bg-amber-50/40` â€” amber left border + subtle background

### File List
- `supabase/migrations/20260223000001_create_product_cmv.sql` â€” NEW
- `app/api/cmv/route.ts` â€” NEW
- `components/cmv/ProductCMVTable.tsx` â€” NEW
- `app/passo-1/page.tsx` â€” NEW
- `__tests__/api/cmv.test.ts` â€” NEW
- `__tests__/components/ProductCMVTable.test.tsx` â€” NEW

---

## QA Results
_A ser preenchido pelo @qa_
