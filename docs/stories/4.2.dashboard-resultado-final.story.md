# Story 4.2: Dashboard de Resultado Final

---

## ‚ö° Parallel Execution Map

```
WAVE 1 ‚úÖ 1.1 Project Scaffold
WAVE 2 ‚úÖ 1.2 + 1.3 OAuth | ‚úÖ 2.1 Seletor
WAVE 3 ‚úÖ 2.2 + 2.3 Busca de Dados
WAVE 4 ‚úÖ 3.1 + 3.2 + 3.3 Fluxo de Entrada
WAVE 5 ‚úÖ 4.1 Motor de C√°lculo (pr√©-requisito desta story)

WAVE 6 ‚Äî VOC√ä EST√Å AQUI ‚Äî √∫ltima story do projeto:
  ‚îî‚îÄ‚îÄ ‚Üí 4.2 Dashboard de Resultado Final    ‚Üê YOU ARE HERE
```

> **4.2 √© a story final** ‚Äî depende de 4.1 (motor de c√°lculo). N√£o h√° paralelo nesta wave.

---

## Status

Ready for Review

---

## Executor Assignment

```
executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "unit-test", "manual-test"]
```

---

## Story

**As a** user,
**I want** to see a clear final report with contribution margin per product and the total operational result,
**so that** I can make informed decisions about pricing and product mix.

---

## Acceptance Criteria

1. Cards de resumo no topo da tela exibindo: "Receita Total", "Total de Impostos", "Total CMV", "Total Despesas", "Resultado Operacional"
2. Tabela detalhada por produto com colunas: Nome | Qtd Vendida | Pre√ßo M√©dio (R$) | Imposto (R$) | CMV Unit. (R$) | MC Unit. (R$) | MC Total (R$)
3. Produtos com MC negativa destacados visualmente (linha ou badge em vermelho)
4. Linha de totais no rodap√© da tabela
5. Bot√£o "Exportar CSV" dispon√≠vel na tela com download direto ‚Äî **obrigat√≥rio**. Bot√£o "Exportar PDF" via `window.print()` √© um **stretch goal** (opcional, n√£o bloqueia a story)
6. Navega√ß√£o para editar qualquer etapa anterior (CMV, Despesas, Al√≠quota) sem perder dados do c√°lculo atual

---

## Scope

### IN scope
- Cards de resumo: Receita Total, Total Impostos, Total CMV, Total Despesas, Resultado Operacional
- Tabela detalhada por produto com todas as colunas de MC
- Destaque visual vermelho para produtos com MC negativa
- Linha de totais no rodap√© da tabela
- Exportar CSV com BOM UTF-8 (download direto, sem backend) ‚Äî **obrigat√≥rio**
- Exportar PDF via `window.print()` com CSS `@media print` ‚Äî **opcional/stretch goal**
- Links de navega√ß√£o para editar CMV, Despesas e Al√≠quota sem perder dados do Context

### OUT of scope
- Salvar relat√≥rio com nome customizado ou snapshot persistido
- Compartilhar relat√≥rio via link ou email
- Compara√ß√£o de resultados entre diferentes per√≠odos
- Visualiza√ß√µes gr√°ficas (charts, gr√°ficos de barras) ‚Äî dashboard textual apenas
- Exporta√ß√£o para Excel nativo (`.xlsx`) ‚Äî CSV √© suficiente para MVP

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| CSV sem UTF-8 BOM causa caracteres corrompidos no Excel PT-BR | High | Medium | Sempre prefixar CSV com `'\uFEFF'` e usar `;` como separador (padr√£o Excel PT-BR). |
| PDF via `window.print()` produz resultados inconsistentes entre browsers | Medium | Low | Marcado como stretch goal ‚Äî comportamento vari√°vel √© aceit√°vel. Adicionar `@media print` estilizado como esfor√ßo de melhoria. |
| Back-navigation + rec√°lculo pode criar race condition se c√°lculo for lento | Low | Medium | Mostrar loading state durante rec√°lculo ao retornar das telas de edi√ß√£o. |
| Dados de c√°lculo dependem do Context ‚Äî se perdidos (refresh), tela fica vazia | Medium | High | Fallback: tentar buscar √∫ltimo resultado de `monthly_results` no Supabase via `GET /api/calculate/result`. |

---

## ü§ñ CodeRabbit Integration

### Story Type Analysis

**Primary Type**: Frontend / UI
**Secondary Type(s)**: Export / Integration
**Complexity**: Medium

### Specialized Agent Assignment

**Primary Agents**:
- @dev: Dashboard, cards, tabela, export, navega√ß√£o de volta

**Supporting Agents**:
- @ux-design-expert: Layout de dashboard financeiro, hierarquia visual clara
- @qa: Validar todos os n√∫meros exibidos vs c√°lculo real

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Unit tests dos componentes, lint, typecheck
- [ ] Pre-PR (@devops): Teste manual do fluxo completo (todas as 6 telas)
- [ ] Pre-Deployment (@devops): Verificar export PDF/CSV em produ√ß√£o

### Self-Healing Configuration

**Expected Self-Healing**:
- Primary Agent: @dev (light mode)
- Max Iterations: 2
- Timeout: 15 minutes
- Severity Filter: CRITICAL, HIGH

**Predicted Behavior**:
- CRITICAL issues: auto_fix
- HIGH issues: document_as_tech_debt

### CodeRabbit Focus Areas

**Primary Focus**:
- Accuracy: N√∫meros no dashboard devem bater 100% com output de `calculateContributionMargin`
- UX: MC negativa visualmente √≥bvia (n√£o sutil), Resultado Operacional em destaque

**Secondary Focus**:
- Accessibility: Tabela com `scope` em headers, contrastes adequados (WCAG AA)
- Export: CSV sem encoding issues (BOM para Excel compat√≠vel com PT-BR)

---

## Tasks / Subtasks

- [x] Criar tela de Resultado Final `/resultado` (AC: 1, 2)
  - [x] Ler `CalculationResult` do Context ou `GET /api/calculate/result?month=M&year=Y`
  - [x] Layout: cards de resumo no topo + tabela detalhada abaixo
- [x] Implementar cards de resumo (AC: 1)
  - [x] 5 cards: Receita Total | Total Impostos | Total CMV | Total Despesas | Resultado Operacional
  - [x] Resultado Operacional: verde se positivo, vermelho se negativo
  - [x] Formato moeda brasileira: `Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' })`
- [x] Implementar tabela detalhada por produto (AC: 2, 3, 4)
  - [x] Colunas: Nome | Qtd | Pre√ßo M√©dio | Imposto | CMV Unit. | MC Unit. | MC Total
  - [x] Linha vermelha (fundo ou texto) para produtos com `mcTotal < 0` (AC: 3)
  - [x] Linha de totais no rodap√©: somar todas as colunas num√©ricas (AC: 4)
  - [x] Ordenar por MC Total desc (produtos mais rent√°veis primeiro)
- [x] Implementar Export CSV (AC: 5)
  - [x] Bot√£o "Exportar CSV" ‚Äî gera CSV com BOM (UTF-8 BOM para compatibilidade Excel PT-BR)
  - [x] Colunas no CSV = colunas da tabela + dados dos cards de resumo ao final
  - [x] Download via `<a href="data:...">` sem backend necess√°rio
- [ ] Implementar Export PDF (AC: 5) ‚Äî opcional/secondary
  - [ ] Usar `window.print()` com CSS `@media print` estilizado
  - [ ] Ou biblioteca `jsPDF` / `react-pdf` se necess√°rio layout complexo
- [x] Implementar navega√ß√£o de volta sem perder dados (AC: 6)
  - [x] Links "Editar CMV", "Editar Despesas", "Editar Al√≠quota" nos cards ou header
  - [x] Dados do c√°lculo atual mantidos no Context ao navegar para edi√ß√£o
  - [x] Ao retornar: recalcular automaticamente com novos dados

---

## Dev Notes

### Fonte de Dados
```typescript
// Ler do Context ou da API:
const result: CalculationResult = useCalculationResult();
// ou
const { data } = await fetch(`/api/calculate/result?month=${month}&year=${year}`);
```

### Layout do Dashboard (PRD Se√ß√£o 3)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Resultado ‚Äî Fevereiro 2026          [Exportar ‚ñº]       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Receita  ‚îÇ Impostos ‚îÇ CMV Total‚îÇ Despesas ‚îÇ Resultado Op ‚îÇ
‚îÇ R$X.XXX  ‚îÇ R$XXX    ‚îÇ R$XXX    ‚îÇ R$XXX    ‚îÇ R$X.XXX ‚úì   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Produto     ‚îÇ Qtd ‚îÇ Pre√ßo ‚îÇ Imposto ‚îÇ CMV ‚îÇ MC Un ‚îÇ MC T ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Produto A   ‚îÇ  10 ‚îÇ 100,00‚îÇ    6,00 ‚îÇ40,00‚îÇ 54,00 ‚îÇ540,00‚îÇ
‚îÇ Produto B ‚ö† ‚îÇ   5 ‚îÇ  20,00‚îÇ    1,20 ‚îÇ25,00‚îÇ -6,20 ‚îÇ-31,00‚îÇ ‚Üê MC negativa (vermelho)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ TOTAL       ‚îÇ  15 ‚îÇ       ‚îÇ    7,20 ‚îÇ     ‚îÇ       ‚îÇ509,00‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    [Editar CMV] [Editar Despesas] [Editar Al√≠quota]
```

### Formato Moeda PT-BR
```typescript
const formatCurrency = (value: number) =>
  new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL',
  }).format(value);
// Resultado: "R$ 1.234,56"
```

### CSV Export com BOM
```typescript
const bom = '\uFEFF';  // UTF-8 BOM para Excel PT-BR
const csv = bom + headers.join(';') + '\n' + rows.map(r => r.join(';')).join('\n');
// Separador ';' para compatibilidade com Excel PT-BR (usa ';' n√£o ',')
```

### Branding no Dashboard (PRD Se√ß√£o 3)
- Resultado positivo: acento verde sutil
- Resultado negativo: acento vermelho
- MC negativa em linha: `bg-red-50` ou `text-red-600`
- Cards: fundo branco, borda cinza sutil, valor em destaque bold

### Testing
- Unit test: formata√ß√£o de moeda
- Unit test: identifica√ß√£o de produtos com MC negativa
- Unit test: c√°lculo de totais do rodap√©
- Manual test: fluxo completo de 6 telas (pr√©-deploy)
- Arquivo: `__tests__/components/ResultDashboard.test.tsx`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-20 | 1.0.0 | Story criada pelo @sm a partir do PRD | River (@sm) |
| 2026-02-21 | 1.1.0 | Adicionadas se√ß√µes Scope e Risks; AC5 corrigido (CSV obrigat√≥rio, PDF optional) per valida√ß√£o @po | River (@sm) |
| 2026-02-23 | 1.2.0 | @po validation ‚Äî Score 10/10 ‚Äî GO ‚Äî Status Draft ‚Üí Ready | Pax (@po) |
| 2026-02-23 | 2.0.0 | @dev implementation ‚Äî 5 files created, 18 tests passing, lint+typecheck clean ‚Äî Status ‚Üí Ready for Review | Dex (@dev) |

---

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-6

### Debug Log References
None ‚Äî no blocking issues encountered.

### Completion Notes List
- CSV export uses UTF-8 BOM (`\uFEFF`) + semicolon separator for PT-BR Excel compatibility
- `/resultado` page auto-triggers POST /api/calculate on load (fetches NF + contas-pagas, then calculates)
- Back-navigation links (CMV/Despesas/Al√≠quota) cause automatic recalculation on return (useEffect re-fires on navigate back)
- Export PDF marked as stretch goal ‚Äî not implemented (out of scope per AC 5)
- `computeFooterTotals` and `formatCurrency` exported for unit-testability

### File List
- `app/resultado/page.tsx` ‚Äî **NEW** Final result dashboard page
- `components/layout/ResultSummaryCards.tsx` ‚Äî **NEW** 5 summary cards with dynamic color
- `components/layout/ProductResultTable.tsx` ‚Äî **NEW** Product table with negative MC highlight + totals row
- `lib/export/csv.ts` ‚Äî **NEW** CSV export utility with BOM
- `__tests__/components/ResultDashboard.test.tsx` ‚Äî **NEW** 18 unit tests (all passing)

---

## QA Results
_A ser preenchido pelo @qa_
