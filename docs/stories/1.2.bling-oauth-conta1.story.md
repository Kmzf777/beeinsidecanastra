# Story 1.2: Bling OAuth 2.0 ‚Äî Conex√£o da Conta 1

---

## ‚ö° Parallel Execution Map

```
WAVE 1 ‚úÖ 1.1 Project Scaffold (pr√©-requisito)

WAVE 2 ‚Äî VOC√ä EST√Å AQUI ‚Äî pode rodar em paralelo:
  ‚îú‚îÄ‚îÄ ‚Üí 1.2 Bling OAuth ‚Äî Conta 1       ‚Üê YOU ARE HERE
  ‚îú‚îÄ‚îÄ ‚Üí 1.3 Bling OAuth ‚Äî Conta 2        ‚Üê PARALLEL com esta story
  ‚îî‚îÄ‚îÄ ‚Üí 2.1 Seletor de Per√≠odo Mensal    ‚Üê PARALLEL com esta story
```

> **1.2 e 1.3 podem ser desenvolvidas em paralelo** ‚Äî s√£o fluxos OAuth independentes (credenciais separadas, tokens separados). O @dev pode dividir o trabalho.

---

## Status

Ready for Review

---

## Executor Assignment

```
executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "integration-test"]
```

---

## Story

**As a** user,
**I want** to connect my first Bling account via OAuth,
**so that** the system can access my sales data securely.

---

## Acceptance Criteria

1. Bot√£o "Conectar Conta Bling 1" na tela de configura√ß√µes redireciona para o fluxo de autoriza√ß√£o Bling OAuth 2.0
2. Ap√≥s autoriza√ß√£o, o callback captura o par√¢metro `code` e realiza a troca por `access_token` + `refresh_token` via chamada server-side
3. Tokens s√£o armazenados de forma segura no Supabase (tabela `bling_tokens`) ‚Äî nunca expostos ao frontend
4. Status de conex√£o ("Conectado" / "N√£o conectado") √© exibido na tela de configura√ß√µes com data da √∫ltima renova√ß√£o
5. Refresh token autom√°tico implementado: quando `access_token` expira, o sistema renova automaticamente antes de cada chamada √† Bling API
6. Tratamento de erro para: autoriza√ß√£o negada pelo usu√°rio, falha na troca de token, token inv√°lido

---

## Scope

### IN scope
- Fluxo OAuth 2.0 completo para Conta 1 (authorize ‚Üí callback ‚Üí token exchange)
- Armazenamento seguro de `access_token` e `refresh_token` na tabela `bling_tokens`
- Refresh autom√°tico de token antes de cada chamada √† Bling API
- Exibi√ß√£o de status de conex√£o ("Conectado" / "N√£o conectado") na tela de configura√ß√µes
- Prote√ß√£o CSRF com par√¢metro `state` no fluxo OAuth
- Tratamento de todos os cen√°rios de erro OAuth

### OUT of scope
- OAuth para Conta 2 (Story 1.3)
- Bot√£o de desconectar (Story 1.3)
- Qualquer chamada √† Bling API al√©m de autentica√ß√£o (Stories 2.x)
- Criptografia adicional de tokens al√©m do RLS do Supabase (service role apenas)
- Registro de usu√°rio ou autentica√ß√£o de sess√£o frontend

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| `BLING_REDIRECT_URI` deve corresponder exatamente ao registrado no portal Bling ‚Äî qualquer diverg√™ncia bloqueia o fluxo | High | High | Registrar URI de redirect no Bling developer portal antes do in√≠cio. Documentar no `.env.example`. |
| Documenta√ß√£o do Bling OAuth pode estar desatualizada ‚Äî par√¢metros e scopes podem variar | Medium | High | Testar fluxo completo com conta sandbox antes de marcar story como Done. |
| Rate limiting no endpoint de token exchange n√£o documentado pelo Bling | Low | Medium | Implementar retry com backoff no token exchange como precau√ß√£o. |

---

## ü§ñ CodeRabbit Integration

### Story Type Analysis

**Primary Type**: Security / Authentication
**Secondary Type(s)**: API Integration, Database
**Complexity**: Medium-High

### Specialized Agent Assignment

**Primary Agents**:
- @dev: OAuth flow implementation, API Routes, token storage
- @architect: Review security design of token storage

**Supporting Agents**:
- @devops: Verify environment variables on Vercel
- @qa: Integration test of OAuth callback flow

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Verificar que nenhum token ou secret √© logado ou exposto ao cliente
- [ ] Pre-PR (@devops): Verificar vari√°veis de ambiente configuradas na Vercel
- [ ] Pre-Deployment (@devops): Security scan ‚Äî tokens nunca em resposta de API p√∫blica

### Self-Healing Configuration

**Expected Self-Healing**:
- Primary Agent: @dev (light mode)
- Max Iterations: 2
- Timeout: 15 minutes
- Severity Filter: CRITICAL, HIGH

**Predicted Behavior**:
- CRITICAL issues: auto_fix (seguran√ßa de tokens, exposi√ß√£o de secrets)
- HIGH issues: document_as_tech_debt

### CodeRabbit Focus Areas

**Primary Focus**:
- Security: Tokens NUNCA retornados ao frontend, armazenamento seguro no Supabase
- Security: `BLING_CLIENT_SECRET_1` apenas em server-side (API Routes), nunca em `NEXT_PUBLIC_*`

**Secondary Focus**:
- Error handling: Todos os casos de falha OAuth tratados com mensagem amig√°vel
- API design: Callback Route protegido contra CSRF (state parameter)

---

## Tasks / Subtasks

- [x] Criar API Route de in√≠cio do OAuth (AC: 1)
  - [x] `GET /api/auth/bling/connect?account=1` ‚Üí gera URL de autoriza√ß√£o Bling com `state` CSRF
  - [x] Redireciona para `https://www.bling.com.br/OAuth/Authorize`
  - [x] Par√¢metros: `client_id`, `redirect_uri`, `state`, `scope=nota_fiscal financeiro`
- [x] Criar API Route de callback OAuth (AC: 2)
  - [x] `GET /api/auth/bling/callback` ‚Üí captura `code` e `state`
  - [x] Valida `state` para prote√ß√£o CSRF
  - [x] Troca `code` por tokens via `POST https://www.bling.com.br/Api/v3/oauth/token`
  - [x] Par√¢metros: `grant_type=authorization_code`, `code`, `redirect_uri`, `client_id`, `client_secret`
- [x] Criar tabela `bling_tokens` no Supabase (AC: 3)
  - [x] Schema: `id`, `account_number` (1 ou 2), `access_token`, `refresh_token`, `expires_at`, `updated_at`
  - [x] Tokens criptografados em repouso (usar Supabase RLS + service role apenas)
  - [x] Salvar tokens ap√≥s callback bem-sucedido
- [x] Criar componente de status de conex√£o (AC: 4)
  - [x] `GET /api/auth/bling/status?account=1` ‚Üí retorna `{ connected: boolean, lastUpdated: string }`
  - [x] Componente `<BlingConnectionStatus account={1} />` exibe "Conectado ‚úì" ou "N√£o conectado"
- [x] Implementar refresh autom√°tico de token (AC: 5)
  - [x] Criar `/lib/bling/token-manager.ts`
  - [x] Fun√ß√£o `getValidToken(accountNumber)`: verifica `expires_at`, renova se necess√°rio
  - [x] `POST https://www.bling.com.br/Api/v3/oauth/token` com `grant_type=refresh_token`
  - [x] Atualiza tokens no Supabase ap√≥s renova√ß√£o
- [x] Implementar tratamento de erros OAuth (AC: 6)
  - [x] Redirecionar para tela de configura√ß√µes com mensagem de erro leg√≠vel
  - [x] Casos: `error=access_denied`, falha HTTP na troca, `invalid_grant` no refresh

---

## Dev Notes

### Bling OAuth 2.0 ‚Äî Refer√™ncia T√©cnica

**Base URL**: `https://www.bling.com.br/Api/v3`

**Endpoints OAuth**:
```
Autoriza√ß√£o: https://www.bling.com.br/OAuth/Authorize
Token:        POST https://www.bling.com.br/Api/v3/oauth/token
```

**Troca de code por token** (server-side):
```typescript
const response = await fetch('https://www.bling.com.br/Api/v3/oauth/token', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded',
    'Authorization': `Basic ${Buffer.from(`${clientId}:${clientSecret}`).toString('base64')}`
  },
  body: new URLSearchParams({
    grant_type: 'authorization_code',
    code: code,
    redirect_uri: redirectUri,
  })
});
```

**Vari√°veis de Ambiente** (server-side only ‚Äî NUNCA `NEXT_PUBLIC_`):
- `BLING_CLIENT_ID_1`
- `BLING_CLIENT_SECRET_1`
- `BLING_REDIRECT_URI` (ex: `https://beeinside.vercel.app/api/auth/bling/callback`)

**Scopes necess√°rios**: `nota_fiscal`, `financeiro`

### Schema Supabase ‚Äî Tabela `bling_tokens`
```sql
CREATE TABLE bling_tokens (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  account_number INTEGER NOT NULL CHECK (account_number IN (1, 2)),
  access_token TEXT NOT NULL,
  refresh_token TEXT NOT NULL,
  expires_at TIMESTAMPTZ NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(account_number)
);
-- RLS: apenas service role pode ler/escrever (tokens nunca acess√≠veis pelo cliente)
ALTER TABLE bling_tokens ENABLE ROW LEVEL SECURITY;
```

### Seguran√ßa (NFR2 do PRD)
> "As credenciais Bling (tokens OAuth e refresh tokens) devem ser armazenadas de forma segura no backend, nunca expostas ao frontend"
- Usar `SUPABASE_SERVICE_ROLE_KEY` nas API Routes para acessar `bling_tokens`
- **Nunca** usar `NEXT_PUBLIC_SUPABASE_ANON_KEY` para opera√ß√µes com tokens
- O frontend s√≥ recebe status de conex√£o, nunca os tokens

### Testing
- **Testes de integra√ß√£o**: Mockar chamada √† Bling API para testar fluxo OAuth sem conta real
- Framework: Jest + `msw` (Mock Service Worker) para mockar HTTP
- Arquivo de teste: `__tests__/api/auth/bling/callback.test.ts`
- Cen√°rios a cobrir: sucesso, `access_denied`, token exchange falhou, refresh falhou

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-20 | 1.0.0 | Story criada pelo @sm a partir do PRD | River (@sm) |
| 2026-02-21 | 1.1.0 | Adicionadas se√ß√µes Scope e Risks per valida√ß√£o @po | River (@sm) |
| 2026-02-22 | 1.2.0 | Implementa√ß√£o completa ‚Äî OAuth connect/callback/status, token-manager, BlingConnectionStatus, settings page, migration | Dex (@dev) |

---

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-6

### Debug Log References
None ‚Äî clean implementation, no debug sessions required.

### Completion Notes List
- `SUPABASE_SERVICE_ROLE_KEY` env var required on server (never exposed to client)
- `BLING_CLIENT_ID_1`, `BLING_CLIENT_SECRET_1`, `BLING_REDIRECT_URI` must be set in `.env.local`
- CSRF state stored as `httpOnly` cookie (`bling_oauth_state`) with 10-min TTL
- Token refresh uses 60s buffer before expiry to avoid race conditions
- Supabase migration must be applied before first OAuth flow: `supabase/migrations/20260220000000_create_bling_tokens.sql`
- `SettingsErrorMessage` uses `useSearchParams` ‚Äî wrapped in `<Suspense>` in settings page (Next.js requirement)

### File List
- `app/api/auth/bling/connect/route.ts` ‚Äî NEW: OAuth start route (generates state, redirects to Bling)
- `app/api/auth/bling/callback/route.ts` ‚Äî NEW: OAuth callback route (CSRF validation, token exchange, Supabase storage)
- `app/api/auth/bling/status/route.ts` ‚Äî NEW: Connection status endpoint
- `app/settings/page.tsx` ‚Äî NEW: Settings page with connect button
- `components/bling/BlingConnectionStatus.tsx` ‚Äî NEW: Client component showing connection status
- `components/bling/SettingsErrorMessage.tsx` ‚Äî NEW: Error/success banner from OAuth redirect params
- `lib/bling/token-manager.ts` ‚Äî NEW: `getValidToken()` with auto-refresh logic
- `lib/supabase/service.ts` ‚Äî NEW: Service-role Supabase client for server-only operations
- `supabase/migrations/20260220000000_create_bling_tokens.sql` ‚Äî NEW: bling_tokens table + RLS

---

## QA Results
_A ser preenchido pelo @qa_
