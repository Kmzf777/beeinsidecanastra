# Story 3.2: Passo 2 ‚Äî Categoriza√ß√£o de Contas Pagas

---

## ‚ö° Parallel Execution Map

```
WAVE 1 ‚úÖ 1.1 Project Scaffold
WAVE 2 ‚úÖ 1.2 + 1.3 OAuth | ‚úÖ 2.1 Seletor de Per√≠odo
WAVE 3 ‚úÖ 2.3 Busca de Contas Pagas (pr√©-requisito desta story)

WAVE 4 ‚Äî VOC√ä EST√Å AQUI ‚Äî pode rodar em paralelo com 3.1 e 3.3:
  ‚îú‚îÄ‚îÄ ‚Üí 3.1 Passo 1 ‚Äî CMV por Produto    ‚Üê PARALLEL (depende de 2.2)
  ‚îú‚îÄ‚îÄ ‚Üí 3.2 Passo 2 ‚Äî Categoriza√ß√£o      ‚Üê YOU ARE HERE (depende de 2.3)
  ‚îî‚îÄ‚îÄ ‚Üí 3.3 Passo 3 ‚Äî Al√≠quota           ‚Üê PARALLEL (depende de 2.1)
```

> **3.2 pode ser desenvolvida em paralelo com 3.1 e 3.3** ‚Äî tela e l√≥gica completamente independentes. Sua depend√™ncia de dados √© a Story 2.3 (contas pagas), diferente das outras.

---

## Status

Ready for Review

---

## Executor Assignment

```
executor: "@dev"
quality_gate: "@dev"
quality_gate_tools: ["lint", "typecheck", "unit-test"]
```

---

## Story

**As a** user,
**I want** to manually categorize each paid account as "Despesa" or "Custo de Produto",
**so that** the system knows what to subtract from the contribution margin.

---

## Acceptance Criteria

1. Lista de contas pagas do per√≠odo exibida com colunas: Descri√ß√£o, Valor (R$), Data de Pagamento, Conta de Origem (Conta 1 / Conta 2)
2. Cada conta possui seletor de categoria com 3 op√ß√µes: **"Despesa"** | **"Custo de Produto"** | **"Ignorar"**
3. Categoriza√ß√µes anteriores para a mesma descri√ß√£o de conta s√£o sugeridas automaticamente (carregadas do Supabase)
4. Total de "Despesas" e "Custo de Produto" exibido em tempo real enquanto o usu√°rio categoriza (cards de resumo no topo)
5. Bot√£o "Salvar e Continuar" persiste todas as categoriza√ß√µes no Supabase e navega para o Passo 3

---

## Scope

### IN scope
- Lista de contas pagas do per√≠odo (dados da Story 2.3)
- Seletor de categoria por conta: "Despesa" | "Custo de Produto" | "Ignorar"
- Sugest√£o autom√°tica de categoria por `descricao` (match case-insensitive do Supabase)
- Cards de resumo com totais em tempo real (Despesas + Custo de Produto)
- Persist√™ncia de categoriza√ß√µes na tabela `account_categories`
- Navega√ß√£o para Passo 3

### OUT of scope
- **"Custo de Produto" N√ÉO subtrai do Resultado Operacional nesta vers√£o** ‚Äî √© puramente informacional. A f√≥rmula final (Story 4.1) usa apenas contas categorizadas como "Despesa". Esta limita√ß√£o √© consciente e alinhada com o PRD FR9 para MVP.
- Cria√ß√£o de categorias customizadas al√©m das 3 definidas
- Categoriza√ß√£o hier√°rquica (subcategorias)
- Compara√ß√£o or√ßado vs realizado
- Exporta√ß√£o da lista de categorias

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Sugest√£o autom√°tica por `descricao` requer nomes consistentes no Bling ‚Äî varia√ß√µes de fornecedor n√£o fazem match | Medium | Medium | Normalizar com `trim().toLowerCase()`. Usu√°rio sempre pode alterar a sugest√£o manualmente. |
| "Custo de Produto" n√£o subtrai do resultado ‚Äî pode confundir usu√°rios que esperam impacto no c√°lculo | Medium | Low | Adicionar tooltip/hint explicativo junto ao seletor: "Informativo ‚Äî n√£o afeta o resultado operacional nesta vers√£o". |
| Dados de contas pagas devem estar dispon√≠veis no Context da Story 2.3 ‚Äî se ausentes, lista fica vazia | High | High | Redirecionar para Dashboard se Context estiver sem dados. |

---

## ü§ñ CodeRabbit Integration

### Story Type Analysis

**Primary Type**: Frontend / UI
**Secondary Type(s)**: Database
**Complexity**: Medium

### Specialized Agent Assignment

**Primary Agents**:
- @dev: Lista com seletor de categoria, persist√™ncia, totais em tempo real

**Supporting Agents**:
- @ux-design-expert: Seletor de categoria claro (toggle ou dropdown), totais em tempo real

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Unit tests de totaliza√ß√£o em tempo real, lint, typecheck
- [ ] Pre-PR (@devops): Testar persist√™ncia de categoriza√ß√µes no Supabase

### Self-Healing Configuration

**Expected Self-Healing**:
- Primary Agent: @dev (light mode)
- Max Iterations: 2
- Timeout: 15 minutes
- Severity Filter: CRITICAL, HIGH

**Predicted Behavior**:
- CRITICAL issues: auto_fix
- HIGH issues: document_as_tech_debt

### CodeRabbit Focus Areas

**Primary Focus**:
- UX: Seletor de categoria intuitivo (toggle/radio, n√£o dropdown complexo)
- Real-time: Totais atualizados imediatamente ao mudar categoria (sem salvar)

**Secondary Focus**:
- Accessibility: Seletor acess√≠vel por teclado (WCAG AA)
- Data: Sugest√£o autom√°tica por `descricao` (case-insensitive match)

---

## Tasks / Subtasks

- [x] Criar lista de contas pagas (AC: 1)
  - [x] Componente `<PaidAccountsList accounts={PaidAccount[]} />`
  - [x] Colunas: Descri√ß√£o | Valor (R$) | Data | Conta Origem | Categoria
  - [x] Dados vindos do resultado da Story 2.3
- [x] Implementar seletor de categoria (AC: 2)
  - [x] Toggle/radio com 3 op√ß√µes: "Despesa" | "Custo de Produto" | "Ignorar"
  - [x] Default: "Ignorar" (sem categorizar)
  - [x] Estilo visual diferenciado por categoria (cores sutis)
- [x] Carregar categoriza√ß√µes anteriores do Supabase (AC: 3)
  - [x] Criar tabela `account_categories` no Supabase
  - [x] Schema: `description TEXT UNIQUE, category TEXT, updated_at TIMESTAMPTZ`
  - [x] `GET /api/categories?descriptions[]=desc1&descriptions[]=desc2`
  - [x] Pr√©-preencher seletor ao carregar (match por `descricao`, case-insensitive)
- [x] Implementar totais em tempo real (AC: 4)
  - [x] Cards no topo: "Total Despesas: R$ X.XXX,XX" e "Total Custo de Produto: R$ X.XXX,XX"
  - [x] Atualizar `useMemo` ou `useEffect` ao mudar qualquer categoriza√ß√£o
  - [x] Ignorar contas com categoria "Ignorar" no c√°lculo
- [x] Implementar "Salvar e Continuar" (AC: 5)
  - [x] `POST /api/categories` ‚Üí upsert de todas as categoriza√ß√µes no Supabase
  - [x] Salvar apenas contas com categoria "Despesa" ou "Custo de Produto"
  - [x] Loading state no bot√£o
  - [x] Ap√≥s salvar: navegar para `/passo-3`

---

## Dev Notes

### Schema Supabase ‚Äî Tabela `account_categories`
```sql
CREATE TABLE account_categories (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  description TEXT NOT NULL,
  category TEXT NOT NULL CHECK (category IN ('Despesa', 'Custo de Produto', 'Ignorar')),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(description)
);
```

### L√≥gica de Sugest√£o Autom√°tica
```typescript
// Match case-insensitive, trim whitespace
const normalize = (s: string) => s.trim().toLowerCase();

// Para cada conta paga, buscar categoria salva por description
const suggestion = savedCategories.find(
  c => normalize(c.description) === normalize(account.descricao)
);
```

### Impacto no C√°lculo Final (Story 4.1)
- Apenas contas categorizadas como **"Despesa"** s√£o subtra√≠das no resultado operacional
- F√≥rmula (PRD FR9): `Resultado = Œ£(MC) ‚àí Œ£(Despesas)`
- Contas "Custo de Produto" e "Ignorar" n√£o entram no c√°lculo de Resultado Operacional
- > "Custo de Produto" √© informativo ‚Äî n√£o subtrai do resultado nesta vers√£o

### Fluxo de Dados
```
Story 2.3 busca contas pagas ‚Üí lista de PaidAccount[]
  ‚Üì
Story 3.2 carrega categoriza√ß√µes anteriores do Supabase
  ‚Üì
Usu√°rio categoriza cada conta
  ‚Üì
"Salvar e Continuar" ‚Üí POST /api/categories ‚Üí Supabase ‚Üí Passo 3
  ‚Üì
Story 4.1 usa categoriza√ß√µes para calcular Œ£(Despesas)
```

### Testing
- Unit test: totaliza√ß√£o em tempo real ao mudar categoria
- Unit test: sugest√£o autom√°tica por descri√ß√£o
- Unit test: "Ignorar" n√£o entra nos totais
- Arquivo: `__tests__/components/PaidAccountsList.test.tsx`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-20 | 1.0.0 | Story criada pelo @sm a partir do PRD | River (@sm) |
| 2026-02-21 | 1.1.0 | Adicionadas se√ß√µes Scope e Risks; "Custo de Produto informacional apenas" explicitado no Scope OUT per valida√ß√£o @po | River (@sm) |
| 2026-02-23 | 1.2.0 | @po validation ‚Äî Score 10/10 ‚Äî GO ‚Äî Status Draft ‚Üí Ready | Pax (@po) |
| 2026-02-23 | 1.3.0 | Implementation complete ‚Äî all 5 tasks done, 20 tests passing, status ‚Üí Ready for Review | Dex (@dev) |

---

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-6

### Debug Log References
None ‚Äî clean implementation, no issues encountered.

### Completion Notes List
- Descriptions stored normalized (lowercase) in Supabase for reliable case-insensitive matching
- `CategoryType` exported from component so the page can import without redefining
- API POST silently skips "Ignorar" entries per story spec (saves only Despesa/Custo de Produto)
- Real-time totals use `useMemo` keyed on `[accounts, categories]` ‚Äî O(n) per change, efficient

### File List
- `supabase/migrations/20260223000004_create_account_categories.sql` (new)
- `app/api/categories/route.ts` (new)
- `components/categorias/PaidAccountsList.tsx` (new)
- `app/passo-2/page.tsx` (new)
- `__tests__/components/PaidAccountsList.test.tsx` (new)

---

## QA Results
_A ser preenchido pelo @qa_
